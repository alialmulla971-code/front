<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù - Ø§Ø­ØªØ³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</title>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· ÙƒÙ…Ø§ Ù‡ÙŠ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 30px 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        h1 {
            color: #1e293b;
            font-size: 36px;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 3px solid #667eea;
            padding-bottom: 15px;
        }
        
        .api-status {
            background: #1e293b;
            color: #10b981;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 14px;
            font-family: monospace;
            direction: ltr;
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s;
            border: 1px solid #e2e8f0;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.2);
        }
        
        .stat-value {
            font-size: 36px;
            font-weight: bold;
            color: #1e293b;
            line-height: 1.2;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 13px;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }
        
        .stat-card.normal .stat-value { color: #10b981; }
        .stat-card.violation .stat-value { color: #ef4444; }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 20px;
            background: white;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin: 25px 0;
            max-height: 600px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }
        
        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
            font-size: 13px;
            padding: 15px 8px;
            text-align: center;
            white-space: nowrap;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            color: #334155;
            font-size: 13px;
        }
        
        tr:hover td {
            background-color: #f8fafc;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        .status-badge {
            padding: 6px 12px;
            border-radius: 30px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
            white-space: nowrap;
        }
        
        .status-normal {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .status-violation {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .time-cell {
            font-family: 'Courier New', monospace;
            font-weight: 600;
            color: #1e293b;
            direction: ltr;
        }
        
        .violation-highlight {
            background-color: #fee2e2;
            font-weight: 600;
            color: #dc2626;
        }
        
        .overtime-positive {
            color: #059669;
            font-weight: 600;
        }
        
        .overtime-negative {
            color: #dc2626;
            font-weight: 600;
        }
        
        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .btn {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
            padding: 10px 20px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .loading {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .message-box {
            padding: 12px 18px;
            border-radius: 16px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }
        
        .message-box.success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
            display: flex;
        }
        
        .message-box.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
            display: flex;
        }
        
        .message-box.info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
            display: flex;
        }
        
        .last-updated {
            color: #64748b;
            font-size: 12px;
            margin-right: auto;
        }
        
        .date-cell {
            font-size: 12px;
            color: #4b5563;
            white-space: nowrap;
        }
        
        .summary-row {
            background: #f1f5f9;
            font-weight: 600;
        }
        
        .summary-row td {
            padding: 15px 8px;
            background: #e2e8f0;
            color: #1e293b;
        }
        
        .auto-refresh-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #64748b;
            margin-right: 15px;
            background: #f1f5f9;
            padding: 5px 12px;
            border-radius: 30px;
        }
        
        .auto-refresh-dot {
            width: 10px;
            height: 10px;
            background-color: #10b981;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }
        
        .countdown {
            font-family: monospace;
            font-size: 14px;
            color: #1e293b;
            font-weight: 600;
        }
        
        .refresh-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-right: 15px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #10b981;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
    </style>
    <!-- SheetJS Ù„Ù‚Ø±Ø§Ø¡Ø© Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>
            ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù
            <span class="api-status" id="apiStatus">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </h1>
        
        <div id="messageBox" class="message-box"></div>
        
        <div class="toolbar">
            <button class="btn btn-primary" onclick="fetchFromAPI()" id="fetchBtn">
                <span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ
            </button>
            <button class="btn" onclick="exportToCSV()" id="exportBtn" disabled>
                <span>ğŸ“¥</span> ØªØµØ¯ÙŠØ± CSV
            </button>
            
            <div class="refresh-control">
                <span style="color: #64748b;">ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="autoRefreshToggle" checked onchange="toggleAutoRefresh()">
                    <span class="slider"></span>
                </label>
            </div>
            
            <div class="auto-refresh-indicator" id="refreshIndicator">
                <span class="auto-refresh-dot"></span>
                <span>Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ: <span id="countdown">5</span> Ø«</span>
            </div>
            
            <div class="last-updated" id="lastUpdated">
                Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
            </div>
        </div>
        
        <div class="stats-container" id="statsContainer" style="display: none;"></div>
        
        <div class="table-wrapper">
            <table id="attendanceTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø£ÙˆÙ„ Ø¨ØµÙ…Ø©</th>
                        <th>Ø«Ø§Ù†ÙŠ Ø¨ØµÙ…Ø©</th>
                        <th>Ø§Ù„ÙØ±Ù‚ (Ø¯)</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</th>
                        <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬<br><small>(Ù…Ø­Ø³ÙˆØ¨ / ÙØ¹Ù„ÙŠ)</small></th>
                        <th>Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†Ø§Ù‚Øµ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 60px; color: #94a3b8;">
                            <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
                            <div style="font-size: 16px;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹...</div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #f1f5f9; border-radius: 16px; font-size: 12px; color: #475569;">
            <strong>âš ï¸ Ø¢Ù„ÙŠØ© Ø§Ø­ØªØ³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬:</strong> 
            <ul style="margin-top: 5px; margin-right: 20px;">
                <li><strong>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¨ØµÙ…ØªÙŠÙ† â‰¤ 20 Ø¯Ù‚ÙŠÙ‚Ø©:</strong> ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ = Ø£ÙˆÙ„ Ø¨ØµÙ…Ø© + 8 Ø³Ø§Ø¹Ø§Øª.</li>
                <li><strong>Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¨ØµÙ…ØªÙŠÙ† > 20 Ø¯Ù‚ÙŠÙ‚Ø©:</strong> ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ = Ø£ÙˆÙ„ Ø¨ØµÙ…Ø© + 8 Ø³Ø§Ø¹Ø§Øª + (Ø§Ù„ÙØ±Ù‚ - 20).</li>
                <li><strong>Ù…Ø«Ø§Ù„ (Ø£Ø­Ù…Ø¯):</strong> 8:10 + 8 Ø³Ø§Ø¹Ø§Øª = 16:10 (ÙˆÙ„ÙŠØ³ 16:00)</li>
                <li><strong>Ù…Ø«Ø§Ù„ (Ø¹Ø§Ø¦Ø´Ø©):</strong> 7:00 + 8 Ø³Ø§Ø¹Ø§Øª + (30-20) = 15:10</li>
            </ul>
        </div>
    </div>

    <script>
        // Ø±Ø§Ø¨Ø· API
        const API_URL = 'https://alialmulla971-2.app.n8n.cloud/webhook-test/employee-attendance-api';
        
        // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        let currentData = [];
        
        // Ø¹Ù†Ø§ØµØ± DOM
        const apiStatus = document.getElementById('apiStatus');
        const messageBox = document.getElementById('messageBox');
        const fetchBtn = document.getElementById('fetchBtn');
        const exportBtn = document.getElementById('exportBtn');
        const tableBody = document.getElementById('tableBody');
        const statsContainer = document.getElementById('statsContainer');
        const lastUpdated = document.getElementById('lastUpdated');
        const refreshIndicator = document.getElementById('refreshIndicator');
        const countdownSpan = document.getElementById('countdown');
        const autoRefreshToggle = document.getElementById('autoRefreshToggle');
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        let autoRefreshInterval = null;
        let countdown = 5;
        let isRefreshing = false;

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
        function showMessage(text, type) {
            messageBox.className = `message-box ${type}`;
            messageBox.innerHTML = `
                <span>${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                <span>${text}</span>
                <span style="margin-right: auto; cursor: pointer;" onclick="this.parentElement.style.display='none'">âœ•</span>
            `;
            messageBox.style.display = 'flex';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageBox.style.display = 'none';
                }, 5000);
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© API
        function updateApiStatus(status, text) {
            apiStatus.textContent = text;
            switch(status) {
                case 'connected':
                    apiStatus.style.color = '#10b981';
                    break;
                case 'disconnected':
                    apiStatus.style.color = '#ef4444';
                    break;
                case 'loading':
                    apiStatus.style.color = '#f59e0b';
                    break;
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¨ØµÙ…ØªÙŠÙ†
        function calculateExpectedLogout(loginFirst, loginSecond) {
            if (!loginFirst || loginFirst === '--:--') return '--:--';
            
            try {
                // ØªØ­ÙˆÙŠÙ„ Ø£ÙˆÙ„ Ø¨ØµÙ…Ø© Ø¥Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚
                const [firstHour, firstMin] = loginFirst.split(':').map(Number);
                let firstMinutes = firstHour * 60 + firstMin;
                
                // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚ Ø¨ÙŠÙ† Ø§Ù„Ø¨ØµÙ…ØªÙŠÙ† (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø«Ø§Ù†ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø©)
                let extraMinutes = 0;
                if (loginSecond && loginSecond !== '--:--') {
                    const [secondHour, secondMin] = loginSecond.split(':').map(Number);
                    const secondMinutes = secondHour * 60 + secondMin;
                    const diff = secondMinutes - firstMinutes;
                    
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙØ±Ù‚ Ø£ÙƒØ¨Ø± Ù…Ù† 20 Ø¯Ù‚ÙŠÙ‚Ø©ØŒ Ù†Ø¶ÙŠÙ (Ø§Ù„ÙØ±Ù‚ - 20)
                    if (diff > 20) {
                        extraMinutes = diff - 20;
                    }
                }
                
                // ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ = Ø£ÙˆÙ„ Ø¨ØµÙ…Ø© + 8 Ø³Ø§Ø¹Ø§Øª (480 Ø¯Ù‚ÙŠÙ‚Ø©) + Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
                const totalMinutes = firstMinutes + 480 + extraMinutes;
                
                const resultHour = Math.floor(totalMinutes / 60) % 24;
                const resultMin = totalMinutes % 60;
                
                return `${resultHour.toString().padStart(2, '0')}:${resultMin.toString().padStart(2, '0')}`;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬:', error);
                return '--:--';
            }
        }

        // Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆØ§Ù„Ù†Ø§Ù‚Øµ (Ù…Ù‚Ø§Ø±Ù†Ø© Ø¨ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙØ¹Ù„ÙŠ)
        function calculateOvertimeAndUndertime(calculatedLogout, actualLogout) {
            if (!actualLogout || actualLogout === '--:--' || !calculatedLogout || calculatedLogout === '--:--') {
                return { overtime: '0:00', undertime: '0:00' };
            }
            
            try {
                const [calcHour, calcMin] = calculatedLogout.split(':').map(Number);
                const [actualHour, actualMin] = actualLogout.split(':').map(Number);
                
                const calcMinutes = calcHour * 60 + calcMin;
                const actualMinutes = actualHour * 60 + actualMin;
                
                const diff = actualMinutes - calcMinutes;
                
                if (diff > 0) {
                    // ÙˆÙ‚Øª Ø¥Ø¶Ø§ÙÙŠ (Ø®Ø±Ø¬ Ø¨Ø¹Ø¯ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨)
                    const hours = Math.floor(diff / 60);
                    const mins = diff % 60;
                    return { overtime: `${hours}:${mins.toString().padStart(2, '0')}`, undertime: '0:00' };
                } else if (diff < 0) {
                    // ÙˆÙ‚Øª Ù†Ø§Ù‚Øµ (Ø®Ø±Ø¬ Ù‚Ø¨Ù„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø³ÙˆØ¨)
                    const absDiff = Math.abs(diff);
                    const hours = Math.floor(absDiff / 60);
                    const mins = absDiff % 60;
                    return { overtime: '0:00', undertime: `${hours}:${mins.toString().padStart(2, '0')}` };
                } else {
                    return { overtime: '0:00', undertime: '0:00' };
                }
            } catch (error) {
                return { overtime: '0:00', undertime: '0:00' };
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Excel Ø¥Ù„Ù‰ JSON
        function parseExcelData(arrayBuffer) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø§Ù… Ù…Ù† Excel:', jsonData);
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
                const today = new Date().toLocaleDateString('ar-SA');
                
                return jsonData.map((row, index) => {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
                    const name = Object.values(row)[0] || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                    const loginFirst = row['login twajdi'] || row['login_twajdi'] || '08:00';
                    const loginSecond = row['login gate'] || row['login_gate'] || '08:00';
                    const diffMinutes = parseInt(row['diff_minutes'] || row['diff minutes'] || 0);
                    const actualLogout = row['Target Logout'] || row['target_logout'] || row['ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬'] || '16:00';
                    
                    // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
                    const calculatedLogout = calculateExpectedLogout(loginFirst, loginSecond);
                    
                    // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆØ§Ù„Ù†Ø§Ù‚Øµ
                    const { overtime, undertime } = calculateOvertimeAndUndertime(calculatedLogout, actualLogout);
                    
                    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„Ø©
                    const status = diffMinutes > 20 ? 'Ù…Ø®Ø§Ù„Ù' : 'Ø·Ø¨ÙŠØ¹ÙŠ';
                    
                    return {
                        name: name,
                        date: today,
                        loginFirst: loginFirst,
                        loginSecond: loginSecond,
                        diffMinutes: diffMinutes,
                        status: status,
                        overtime: overtime,
                        undertime: undertime,
                        actualLogout: actualLogout,
                        calculatedLogout: calculatedLogout
                    };
                });
            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© Excel:', error);
                throw new Error('ÙØ´Ù„ Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Excel');
            }
        }

        // Ø¯Ø§Ù„Ø© Ø³Ø­Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† API
        async function fetchFromAPI() {
            if (isRefreshing) return;
            
            isRefreshing = true;
            updateApiStatus('loading', 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...');
            fetchBtn.disabled = true;
            fetchBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«...';
            
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json, application/vnd.ms-excel, */*'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„: ${response.status} ${response.statusText}`);
                }
                
                const contentType = response.headers.get('content-type');
                console.log('Ù†ÙˆØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙ‰:', contentType);
                
                let data;
                
                if (contentType && (contentType.includes('excel') || contentType.includes('spreadsheet') || contentType.includes('octet-stream'))) {
                    const arrayBuffer = await response.arrayBuffer();
                    data = parseExcelData(arrayBuffer);
                } 
                else if (contentType && contentType.includes('json')) {
                    data = await response.json();
                } 
                else {
                    const text = await response.text();
                    try {
                        data = JSON.parse(text);
                    } catch {
                        throw new Error('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© Ù„ÙŠØ³Øª JSON ÙˆÙ„Ø§ Excel');
                    }
                }
                
                if (!Array.isArray(data)) {
                    if (data && typeof data === 'object') {
                        data = [data];
                    } else {
                        throw new Error('ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­');
                    }
                }
                
                console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:', data);
                
                currentData = data;
                displayData(data);
                
                updateApiStatus('connected', 'âœ… Ù…ØªØµÙ„');
                showMessage(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« ${data.length} Ø³Ø¬Ù„`, 'success');
                exportBtn.disabled = false;
                
            } catch (error) {
                console.error('Ø®Ø·Ø£:', error);
                updateApiStatus('disconnected', 'âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«');
                showMessage(`âŒ Ø®Ø·Ø£: ${error.message}`, 'error');
                
                if (currentData.length === 0) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="10" style="text-align: center; padding: 60px;">
                                <div style="font-size: 48px; color: #ef4444; margin-bottom: 15px;">âŒ</div>
                                <div style="color: #64748b; margin-bottom: 10px;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
                                <div style="color: #94a3b8; font-size: 13px;">${error.message}</div>
                                <button onclick="fetchFromAPI()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 30px; cursor: pointer;">
                                    Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                                </button>
                            </td>
                        </tr>
                    `;
                }
                
            } finally {
                isRefreshing = false;
                fetchBtn.disabled = false;
                fetchBtn.innerHTML = '<span>ğŸ”„</span> ØªØ­Ø¯ÙŠØ« ÙŠØ¯ÙˆÙŠ';
                countdown = 5;
            }
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
        function displayData(data) {
            if (!data || data.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; padding: 60px; color: #94a3b8;">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¹Ø±Ø¶
                        </td>
                    </tr>
                `;
                statsContainer.style.display = 'none';
                return;
            }
            
            let totalEmployees = data.length;
            let normalCount = 0;
            let violationCount = 0;
            let totalOvertime = 0;
            let totalUndertime = 0;
            
            // Ø¨Ù†Ø§Ø¡ ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
            let tableHtml = '';
            
            data.forEach((item, index) => {
                const status = item.status || 'Ø·Ø¨ÙŠØ¹ÙŠ';
                const diff = parseInt(item.diffMinutes) || 0;
                
                if (status === 'Ø·Ø¨ÙŠØ¹ÙŠ') normalCount++;
                else violationCount++;
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆØ§Ù„Ù†Ø§Ù‚Øµ Ø¥Ù„Ù‰ Ø¯Ù‚Ø§Ø¦Ù‚ Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
                const overtimeParts = (item.overtime || '0:00').split(':').map(Number);
                const overtimeMinutes = (overtimeParts[0] || 0) * 60 + (overtimeParts[1] || 0);
                totalOvertime += overtimeMinutes;
                
                const undertimeParts = (item.undertime || '0:00').split(':').map(Number);
                const undertimeMinutes = (undertimeParts[0] || 0) * 60 + (undertimeParts[1] || 0);
                totalUndertime += undertimeMinutes;
                
                const statusClass = status === 'Ø·Ø¨ÙŠØ¹ÙŠ' ? 'status-normal' : 'status-violation';
                const diffClass = diff > 20 ? 'violation-highlight' : '';
                
                // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙˆØ§Ù„Ù†Ø§Ù‚Øµ
                const overtimeDisplay = item.overtime || '0:00';
                const undertimeDisplay = item.undertime || '0:00';
                
                const overtimeClass = overtimeDisplay !== '0:00' ? 'overtime-positive' : '';
                const undertimeClass = undertimeDisplay !== '0:00' ? 'overtime-negative' : '';
                
                // Ø¹Ø±Ø¶ ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬ (Ù…Ø­Ø³ÙˆØ¨ / ÙØ¹Ù„ÙŠ)
                const logoutDisplay = `
                    <div>${item.calculatedLogout || '--:--'}</div>
                    <div style="font-size: 11px; color: #64748b;">${item.actualLogout || '--:--'}</div>
                `;
                
                tableHtml += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${item.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</strong></td>
                        <td class="date-cell">${item.date || '--'}</td>
                        <td class="time-cell">${item.loginFirst || '--:--'}</td>
                        <td class="time-cell">${item.loginSecond || '--:--'}</td>
                        <td class="${diffClass}">${diff} Ø¯</td>
                        <td><span class="status-badge ${statusClass}">${status}</span></td>
                        <td class="${overtimeClass}">${overtimeDisplay}</td>
                        <td>${logoutDisplay}</td>
                        <td class="${undertimeClass}">${undertimeDisplay}</td>
                    </tr>
                `;
            });
            
            // Ø¥Ø¶Ø§ÙØ© ØµÙ Ø§Ù„Ù…Ù„Ø®Øµ
            tableHtml += `
                <tr class="summary-row">
                    <td colspan="2" style="text-align: right;"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                    <td>${totalEmployees}</td>
                    <td colspan="2">Ø·Ø¨ÙŠØ¹ÙŠ: ${normalCount} | Ù…Ø®Ø§Ù„Ù: ${violationCount}</td>
                    <td></td>
                    <td></td>
                    <td><strong>${Math.floor(totalOvertime / 60)}:${(totalOvertime % 60).toString().padStart(2,'0')}</strong></td>
                    <td></td>
                    <td><strong>${Math.floor(totalUndertime / 60)}:${(totalUndertime % 60).toString().padStart(2,'0')}</strong></td>
                </tr>
            `;
            
            tableBody.innerHTML = tableHtml;
            
            // Ø¨Ù†Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalEmployees}</div>
                    <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</div>
                </div>
                <div class="stat-card normal">
                    <div class="stat-value">${normalCount}</div>
                    <div class="stat-label">Ø­Ø§Ù„Ø© Ø·Ø¨ÙŠØ¹ÙŠØ©</div>
                </div>
                <div class="stat-card violation">
                    <div class="stat-value">${violationCount}</div>
                    <div class="stat-label">Ù…Ø®Ø§Ù„ÙÙŠÙ†</div>
                </div>
            `;
            
            statsContainer.style.display = 'grid';
            
            const now = new Date();
            lastUpdated.textContent = `Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: ${now.toLocaleDateString('ar-SA')} ${now.toLocaleTimeString('ar-SA')}`;
        }

        // Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± CSV
        function exportToCSV() {
            if (!currentData || currentData.length === 0) {
                showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±', 'error');
                return;
            }
            
            let csv = 'Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ØªØ§Ø±ÙŠØ®,Ø£ÙˆÙ„ Ø¨ØµÙ…Ø©,Ø«Ø§Ù†ÙŠ Ø¨ØµÙ…Ø©,Ø§Ù„ÙØ±Ù‚ (Ø¯),Ø§Ù„Ø­Ø§Ù„Ø©,Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ,Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø­Ø³ÙˆØ¨,Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ù„ÙØ¹Ù„ÙŠ,Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù†Ø§Ù‚Øµ\n';
            
            currentData.forEach(item => {
                const status = item.status || 'Ø·Ø¨ÙŠØ¹ÙŠ';
                csv += `${item.name},${item.date || ''},${item.loginFirst},${item.loginSecond},${item.diffMinutes},${status},${item.overtime || '0:00'},${item.calculatedLogout || '--:--'},${item.actualLogout},${item.undertime || '0:00'}\n`;
            });
            
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.href = url;
            link.setAttribute('download', `attendance_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            showMessage('ØªÙ… ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        function updateCountdown() {
            if (!autoRefreshToggle.checked) return;
            
            countdown--;
            countdownSpan.textContent = countdown;
            
            if (countdown <= 0) {
                countdown = 5;
                fetchFromAPI();
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        function toggleAutoRefresh() {
            if (autoRefreshToggle.checked) {
                countdown = 5;
                countdownSpan.textContent = countdown;
                autoRefreshInterval = setInterval(updateCountdown, 1000);
                refreshIndicator.style.opacity = '1';
                showMessage('ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†', 'success');
            } else {
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
                refreshIndicator.style.opacity = '0.5';
                countdownSpan.textContent = 'Ù…ØªÙˆÙ‚Ù';
                showMessage('ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ', 'info');
            }
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = function() {
            setTimeout(() => {
                fetchFromAPI();
            }, 500);
            
            toggleAutoRefresh();
        };
    </script>
</body>
</html>
